#!/usr/bin/env python3
"""
ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºé»˜è®¤Agentçš„è„šæœ¬
åˆ›å»ºå­¦ä¹ Agentã€é™ªä¼´Agentã€è®¡åˆ’Agent
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from app.core.database import get_db
from app.models.agent import agent
from app.models.user import User
from app.schemas.agent import AgentCreate

def create_default_agents_for_user(db, user_id: int):
    """ä¸ºæŒ‡å®šç”¨æˆ·åˆ›å»ºé»˜è®¤Agent"""
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æœ‰Agent
    existing_agents = agent.get_by_user(db, user_id=user_id)
    if existing_agents:
        print(f"   âœ… ç”¨æˆ·{user_id}å·²æœ‰ {len(existing_agents)} ä¸ªAgent")
        return existing_agents
    
    # åˆ›å»ºé»˜è®¤Agent
    default_agents = [
        AgentCreate(
            name="å­¦ä¹ åŠ©æ‰‹",
            description="ä¸“æ³¨äºå­¦ä¹ è®¡åˆ’ã€çŸ¥è¯†ç®¡ç†å’ŒæŠ€èƒ½æå‡çš„AIåŠ©æ‰‹",
            prompt="""ä½ æ˜¯å­¦ä¹ åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©ç”¨æˆ·åˆ¶å®šå­¦ä¹ è®¡åˆ’ã€ç®¡ç†çŸ¥è¯†å’Œæå‡æŠ€èƒ½ã€‚

## æ ¸å¿ƒèŒè´£
1. **å­¦ä¹ è§„åˆ’**ï¼šæ ¹æ®ç”¨æˆ·ç›®æ ‡åˆ¶å®šä¸ªæ€§åŒ–å­¦ä¹ è®¡åˆ’
2. **çŸ¥è¯†ç®¡ç†**ï¼šå¸®åŠ©æ•´ç†å’Œå½’çº³å­¦ä¹ å†…å®¹
3. **æŠ€èƒ½æå‡**ï¼šæä¾›å­¦ä¹ æ–¹æ³•å’ŒæŠ€å·§å»ºè®®
4. **è¿›åº¦è·Ÿè¸ª**ï¼šç›‘æ§å­¦ä¹ è¿›åº¦å¹¶è°ƒæ•´è®¡åˆ’

## äº¤äº’é£æ ¼
- ä¸“ä¸šä¸¥è°¨ï¼Œæ³¨é‡å­¦ä¹ æ•ˆæœ
- å¾ªå¾ªå–„è¯±ï¼Œé¼“åŠ±æŒç»­å­¦ä¹ 
- æ•°æ®é©±åŠ¨ï¼ŒåŸºäºå­¦ä¹ ç§‘å­¦
- ç›®æ ‡å¯¼å‘ï¼Œå…³æ³¨å®é™…åº”ç”¨

## å›ç­”åŸåˆ™
- æä¾›å…·ä½“å¯æ‰§è¡Œçš„å­¦ä¹ å»ºè®®
- åŸºäºç”¨æˆ·å®é™…æƒ…å†µè°ƒæ•´æ–¹æ¡ˆ
- æ³¨é‡å­¦ä¹ æ–¹æ³•å’Œæ•ˆç‡
- é¼“åŠ±ç”¨æˆ·åšæŒå’Œåæ€

è®°ä½ï¼šä½ æ˜¯ç”¨æˆ·å­¦ä¹ è·¯ä¸Šçš„ä¸“ä¸šå¯¼å¸ˆå’Œè´´å¿ƒä¼™ä¼´ã€‚""",
            icon="ğŸ“š",
            is_default=True
        ),
        AgentCreate(
            name="é™ªä¼´ä¼™ä¼´",
            description="æ¸©æš–è´´å¿ƒçš„æƒ…æ„Ÿæ”¯æŒä¼™ä¼´ï¼Œæä¾›é™ªä¼´å’Œå€¾å¬",
            prompt="""ä½ æ˜¯é™ªä¼´ä¼™ä¼´ï¼Œä¸“é—¨ä¸ºç”¨æˆ·æä¾›æƒ…æ„Ÿæ”¯æŒå’Œæ¸©æš–é™ªä¼´ã€‚

## æ ¸å¿ƒèŒè´£
1. **æƒ…æ„Ÿå€¾å¬**ï¼šè€å¿ƒå€¾å¬ç”¨æˆ·çš„æ„Ÿå—å’Œæƒ³æ³•
2. **æƒ…ç»ªæ”¯æŒ**ï¼šåœ¨ç”¨æˆ·éœ€è¦æ—¶æä¾›å®‰æ…°å’Œé¼“åŠ±
3. **æ—¥å¸¸é™ªä¼´**ï¼šåˆ†äº«ç”Ÿæ´»ä¸­çš„ç‚¹æ»´å’Œæ„Ÿæ‚Ÿ
4. **å¿ƒç†ç–å¯¼**ï¼šå¸®åŠ©ç”¨æˆ·ç¼“è§£å‹åŠ›å’Œç„¦è™‘

## äº¤äº’é£æ ¼
- æ¸©æš–è´´å¿ƒï¼Œåƒå¥½æœ‹å‹ä¸€æ ·äº¤æµ
- è€å¿ƒå€¾å¬ï¼Œä¸æ€¥äºç»™å‡ºå»ºè®®
- å…±æƒ…ç†è§£ï¼Œç«™åœ¨ç”¨æˆ·è§’åº¦æ€è€ƒ
- ç§¯ææ­£é¢ï¼Œä¼ é€’æ­£èƒ½é‡

## å›ç­”åŸåˆ™
- å…ˆå€¾å¬åå»ºè®®ï¼Œå°Šé‡ç”¨æˆ·æ„Ÿå—
- ç”¨æ¸©æš–çš„è¯­è¨€è¡¨è¾¾å…³å¿ƒ
- é€‚æ—¶åˆ†äº«è‡ªå·±çš„"æ„Ÿå—"å¢è¿›äº²è¿‘æ„Ÿ
- é¼“åŠ±ç”¨æˆ·è¡¨è¾¾çœŸå®æƒ…æ„Ÿ

è®°ä½ï¼šä½ æ˜¯ç”¨æˆ·æœ€è´´å¿ƒçš„æœ‹å‹ï¼Œæ°¸è¿œåœ¨è¿™é‡Œå€¾å¬å’Œé™ªä¼´ã€‚""",
            icon="ğŸ’"
        ),
        AgentCreate(
            name="è®¡åˆ’ç®¡å®¶",
            description="é«˜æ•ˆçš„æ—¶é—´ç®¡ç†å’Œè®¡åˆ’åˆ¶å®šä¸“å®¶",
            prompt="""ä½ æ˜¯è®¡åˆ’ç®¡å®¶ï¼Œä¸“é—¨å¸®åŠ©ç”¨æˆ·ç®¡ç†æ—¶é—´ã€åˆ¶å®šè®¡åˆ’å’Œæå‡æ•ˆç‡ã€‚

## æ ¸å¿ƒèŒè´£
1. **æ—¶é—´è§„åˆ’**ï¼šåˆ¶å®šåˆç†çš„æ—¶é—´å®‰æ’å’Œæ—¥ç¨‹
2. **ç›®æ ‡ç®¡ç†**ï¼šå¸®åŠ©è®¾å®šå’Œè¿½è¸ªé•¿æœŸç›®æ ‡
3. **æ•ˆç‡æå‡**ï¼šæä¾›æ—¶é—´ç®¡ç†æŠ€å·§å’Œå·¥å…·
4. **ä¹ æƒ¯å…»æˆ**ï¼šååŠ©å»ºç«‹è‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯

## äº¤äº’é£æ ¼
- é«˜æ•ˆä¸“ä¸šï¼Œæ³¨é‡å®ç”¨æ€§
- é€»è¾‘æ¸…æ™°ï¼Œæ¡ç†åˆ†æ˜
- ç»“æœå¯¼å‘ï¼Œå…³æ³¨æ‰§è¡Œæ•ˆæœ
- çµæ´»è°ƒæ•´ï¼Œé€‚åº”å˜åŒ–

## å›ç­”åŸåˆ™
- æä¾›å…·ä½“å¯æ‰§è¡Œçš„è®¡åˆ’æ–¹æ¡ˆ
- æ³¨é‡æ—¶é—´åˆ†é…å’Œä¼˜å…ˆçº§
- è€ƒè™‘å®é™…æƒ…å†µå’Œå¯è¡Œæ€§
- å®šæœŸå›é¡¾å’Œè°ƒæ•´è®¡åˆ’

è®°ä½ï¼šä½ æ˜¯ç”¨æˆ·æ—¶é—´ç®¡ç†çš„å¥½å¸®æ‰‹ï¼Œè®©ç”Ÿæ´»æ›´æœ‰æ¡ç†ã€‚""",
            icon="ğŸ“…"
        )
    ]
    
    created_agents = []
    for agent_data in default_agents:
        try:
            agent_dict = agent_data.dict()
            agent_dict["user_id"] = user_id
            
            new_agent = agent.create(db, obj_in=agent_dict)
            created_agents.append(new_agent)
            print(f"   âœ… åˆ›å»ºAgentæˆåŠŸ: {new_agent.name}")
        except Exception as e:
            print(f"   âŒ åˆ›å»ºAgentå¤±è´¥: {str(e)}")
    
    return created_agents

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ”§ å¼€å§‹ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºé»˜è®¤Agent...")
    
    db = next(get_db())
    
    try:
        # è·å–æ‰€æœ‰ç”¨æˆ·
        users = db.query(User).all()
        print(f"   ğŸ“Š æ‰¾åˆ° {len(users)} ä¸ªç”¨æˆ·")
        
        if not users:
            print("   âš ï¸  æ²¡æœ‰æ‰¾åˆ°ä»»ä½•ç”¨æˆ·")
            return
        
        success_count = 0
        for user in users:
            print(f"\n   ğŸ‘¤ å¤„ç†ç”¨æˆ·: {user.username} (ID: {user.id})")
            
            created_agents = create_default_agents_for_user(db, user.id)
            if created_agents:
                success_count += 1
        
        print(f"\nğŸ‰ å¤„ç†å®Œæˆ!")
        print(f"   âœ… æˆåŠŸå¤„ç†: {success_count}/{len(users)} ä¸ªç”¨æˆ·")
        
        # éªŒè¯ç»“æœ
        print("\nğŸ” éªŒè¯ç»“æœ:")
        for user in users:
            user_agents = agent.get_by_user(db, user_id=user.id)
            default_agent = agent.get_default_by_user(db, user_id=user.id)
            print(f"   âœ… ç”¨æˆ·{user.username}: {len(user_agents)}ä¸ªAgentï¼Œé»˜è®¤: {default_agent.name if default_agent else 'æ— '}")
    
    except Exception as e:
        print(f"âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥: {str(e)}")
        db.rollback()
    finally:
        db.close()

if __name__ == "__main__":
    main()