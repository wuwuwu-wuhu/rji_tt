# LifeLog AI 项目智能记录

## 项目核心模式

### 开发模式
- **前后端分离**: 前端Next.js + 后端FastAPI，通过REST API通信
- **组件化开发**: 前端高度组件化，后端模块化设计
- **API优先**: 后端API先行，前端UI后实现
- **渐进集成**: 分阶段集成，确保稳定性

### 代码组织模式
- **前端**: `app/`路由 + `components/`组件 + `contexts/`状态 + `lib/`工具
- **后端**: `api/routes/`路由 + `models/`模型 + `services/`服务 + `db/`数据访问
- **共享**: 类型定义、常量、工具函数保持一致

### 数据流模式
- **单向数据流**: 用户操作 → API调用 → 状态更新 → UI重渲染
- **乐观更新**: 前端先更新UI，后端同步失败时回滚
- **缓存策略**: 热点数据缓存，定期刷新
- **错误边界**: 组件级错误捕获，全局错误处理

## 技术决策记录

### 前端技术选择
- **Next.js 16**: 选择理由：App Router架构现代化，性能优秀，SEO友好
- **React 19**: 选择理由：最新特性，并发支持，开发体验好
- **TypeScript**: 选择理由：类型安全，开发效率高，维护成本低
- **Tailwind CSS 4**: 选择理由：开发速度快，一致性高，维护简单
- **Radix UI**: 选择理由：可访问性好，无样式设计，高度可定制

### 后端技术选择
- **FastAPI**: 选择理由：性能优秀，文档自动生成，类型提示支持
- **PostgreSQL**: 选择理由：功能强大，扩展性好，社区支持好
- **SQLAlchemy**: 选择理由：ORM成熟，迁移支持，查询构建器
- **Redis**: 选择理由：性能优秀，数据结构丰富，持久化支持
- **JWT**: 选择理由：无状态，跨域支持，标准化

### 架构模式
- **分层架构**: 路由层 → 业务层 → 数据层 → 存储层
- **依赖注入**: 使用FastAPI的Depends系统
- **仓储模式**: 封装数据访问逻辑
- **服务层模式**: 封装业务逻辑

## 开发规范

### 命名规范
- **文件命名**: kebab-case（如：user-profile.tsx）
- **组件命名**: PascalCase（如：UserProfile）
- **函数命名**: camelCase（如：getUserProfile）
- **变量命名**: camelCase（如：userName）
- **常量命名**: UPPER_SNAKE_CASE（如：API_BASE_URL）
- **数据库表命名**: snake_case（如：user_profiles）

### 代码结构规范
- **组件结构**: Props接口 → 组件定义 → 默认导出
- **API结构**: 路由定义 → 参数验证 → 业务逻辑 → 响应返回
- **模型结构**: 类定义 → 字段定义 → 关系定义 → 方法定义
- **测试结构**: 描述 → 设置 → 测试用例 → 清理

### 注释规范
- **文件注释**: 文件顶部说明文件用途
- **函数注释**: 复杂函数必须添加注释
- **业务逻辑注释**: 关键业务逻辑添加注释
- **TODO注释**: 临时解决方案添加TODO注释

## 项目特定模式

### AI助手集成模式
- **状态管理**: 使用Context管理AI面板状态
- **API调用**: 统一的AI服务封装
- **错误处理**: AI服务降级机制
- **用户体验**: 加载状态和错误提示
- **配置管理**: 支持多模型配置和默认设置
- **调试日志**: 完善的调试日志体系，便于问题定位
- **知识库集成**: 支持知识库数据查询和集成

### 认证授权模式
- **JWT管理**: 本地存储 + 自动刷新
- **路由保护**: 高阶组件包装受保护路由
- **权限控制**: 基于角色的访问控制
- **用户体验**: 登录状态持久化

### 数据同步模式
- **实时同步**: WebSocket或轮询更新
- **冲突解决**: 时间戳或版本号机制
- **离线支持**: 本地缓存 + 同步队列
- **错误恢复**: 自动重试 + 手动同步

### 数据库模式
- **数据库类型**: PostgreSQL
- **连接配置**: `postgresql://postgres:password@localhost:5432/lifelog_db`
- **配置文件**: `backend-code/app/core/config.py` 和 `.env`
- **连接管理**: SQLAlchemy连接池
- **迁移管理**: Alembic版本控制
- **初始化脚本**: `python init_db.py`
- **查询优化**: 索引和查询优化

### 数据库设置流程

#### 开发环境（手动设置）
1. **手动创建数据库**:
   ```bash
   psql -h localhost -U postgres
   CREATE DATABASE lifelog_db;
   \q
   ```

2. **初始化数据库表**:
   ```bash
   cd backend-code
   python init_db.py
   ```

3. **运行数据库迁移** (可选):
   ```bash
   alembic revision --autogenerate -m "Initial migration"
   alembic upgrade head
   ```

#### 生产环境（自动化设置）
1. **Docker Compose一键部署**:
   ```bash
   docker-compose up -d
   ```

2. **自动化脚本**:
   - `setup_database.py` - 自动创建数据库和表
   - `init-db.sh` - PostgreSQL容器初始化
   - 支持服务依赖和健康检查

### 数据库操作模式
- **模型定义**: 使用SQLAlchemy ORM模型
- **关系管理**: 明确的外键关系定义
- **会话管理**: 使用依赖注入获取数据库会话
- **事务处理**: 自动提交和回滚机制
- **数据验证**: Pydantic模型验证

## 常见问题解决方案

### 前端常见问题
1. **组件重渲染优化**
   - 使用React.memo包装组件
   - 使用useMemo和useCallback优化
   - 避免在render中创建新对象

2. **状态管理复杂化**
   - 保持状态简单，避免过度抽象
   - 使用useReducer处理复杂状态
   - 考虑状态提升到合适层级

3. **API调用管理**
   - 使用自定义Hook封装API调用
   - 实现请求去重和缓存
   - 添加加载状态和错误处理

### 后端常见问题
1. **数据库查询优化**
   - 使用索引优化查询性能
   - 避免N+1查询问题
   - 使用连接池管理数据库连接

2. **API性能优化**
   - 实现响应缓存
   - 使用分页减少数据传输
   - 异步处理长时间操作

3. **安全防护**
   - 输入验证和过滤
   - SQL注入防护
   - XSS攻击防护

### AI功能常见问题
1. **AI聊天功能调试**
   - 建立完善的调试日志体系
   - 详细记录请求响应信息
   - 实现分层错误处理机制
   - 提供用户友好的错误提示

2. **AI配置管理**
   - 支持多模型配置和默认设置
   - 实现配置的增删改查功能
   - 提供配置测试和验证机制
   - 优化配置选择器用户界面

3. **AI知识库集成**
   - 优化知识库数据查询性能
   - 实现知识库数据量控制
   - 支持知识库数据实时更新
   - 提供知识库使用统计

4. **AI服务错误处理**
   - 实现AI服务降级机制
   - 提供详细的错误诊断信息
   - 创建错误修复指南和调试工具
   - 建立错误监控和告警机制

## 性能优化策略

### 前端性能优化
- **代码分割**: 按路由和组件分割代码
- **懒加载**: 非关键资源懒加载
- **图片优化**: 响应式图片和懒加载
- **缓存策略**: 浏览器缓存和CDN缓存
- **包大小优化**: Tree-shaking和压缩

### 后端性能优化
- **数据库优化**: 查询优化和索引设计
- **缓存策略**: 多层缓存提高响应速度
- **异步处理**: 异步I/O提高并发能力
- **连接池**: 数据库连接池管理
- **负载均衡**: 支持水平扩展

## 测试策略

### 前端测试
- **单元测试**: 组件和函数测试
- **集成测试**: 组件间交互测试
- **端到端测试**: 完整用户流程测试
- **视觉回归测试**: UI变化检测

### 后端测试
- **单元测试**: 函数和类测试
- **集成测试**: API和数据库测试
- **性能测试**: 负载和压力测试
- **安全测试**: 漏洞和渗透测试

## 部署和运维

### 部署策略
- **容器化**: Docker容器化部署
- **环境隔离**: 开发、测试、生产环境分离
- **蓝绿部署**: 零停机部署策略
- **回滚机制**: 快速回滚能力

### 监控和日志
- **应用监控**: 性能和错误监控
- **日志管理**: 结构化日志收集
- **告警机制**: 关键指标告警
- **健康检查**: 服务状态监控

## 团队协作

### 代码审查
- **审查标准**: 代码质量、性能、安全性
- **审查流程**: Pull Request + Code Review
- **审查工具**: GitHub/GitLab Code Review
- **审查记录**: 问题跟踪和解决

### 文档管理
- **API文档**: 自动生成 + 手动补充
- **代码文档**: 关键逻辑注释
- **架构文档**: 系统设计文档
- **运维文档**: 部署和运维指南

## 工具和配置

### 开发工具
- **IDE**: VS Code + 相关插件
- **版本控制**: Git + GitHub
- **包管理**: pnpm (前端) + pip (后端)
- **调试工具**: 浏览器DevTools + Python调试器

### 代码质量工具
- **代码检查**: ESLint + Prettier (前端) + Black + Flake8 (后端)
- **类型检查**: TypeScript + MyPy
- **测试工具**: Jest + React Testing Library + pytest
- **构建工具**: Next.js + FastAPI内置

## 学习和成长

### 技术学习
- **新技术评估**: 定期评估新技术
- **最佳实践**: 关注行业最佳实践
- **性能优化**: 学习性能优化技巧
- **安全知识**: 提升安全意识

### 项目经验
- **问题解决**: 记录问题和解决方案
- **性能优化**: 总结优化经验
- **架构设计**: 学习架构设计原则
- **团队协作**: 提升协作效率

## 移动端打包策略

### 双APK方案
1. **纯前端APK**:
   - 基于Capacitor + PWA
   - 连接远程API服务器
   - 轻量级，需要网络连接

2. **完整APK**:
   - 内置本地API服务
   - SQLite本地数据库
   - 支持离线使用

### 构建流程
- **前端构建**: Next.js → PWA → Capacitor
- **本地API**: Flask + SQLite
- **打包脚本**: 自动化构建和APK生成

### 技术实现
- **Capacitor**: PWA到原生应用转换
- **本地服务**: Flask API嵌入式运行
- **数据同步**: 本地SQLite与远程API同步

## 调试和问题解决模式

### 调试日志体系
1. **分层日志记录**
   - 前端API客户端：详细记录请求响应信息
   - 后端服务：记录业务逻辑和错误信息
   - 数据库操作：记录查询和事务信息
   - AI服务：记录配置和调用详情

2. **调试信息结构化**
   - 使用统一的日志格式
   - 包含时间戳、级别、模块、消息
   - 支持日志级别控制（DEBUG、INFO、WARN、ERROR）
   - 实现日志文件输出和轮转

3. **错误诊断机制**
   - 提供详细的错误堆栈信息
   - 记录用户操作上下文
   - 实现错误分类和统计
   - 创建错误修复指南和调试工具

### 问题解决流程
1. **问题识别**
   - 用户反馈和监控告警
   - 日志分析和错误追踪
   - 复现问题和定位根因

2. **问题分析**
   - 技术方案设计和评估
   - 影响范围和风险评估
   - 修复优先级和时间规划

3. **问题修复**
   - 代码实现和测试验证
   - 文档更新和知识沉淀
   - 部署发布和效果验证

### AI功能调试经验
1. **配置管理调试**
   - 详细记录配置变更历史
   - 提供配置测试和验证功能
   - 实现配置回滚和恢复机制

2. **AI服务调试**
   - 记录AI模型调用参数和响应
   - 监控AI服务性能和可用性
   - 实现AI服务降级和容错机制

3. **知识库调试**
   - 监控知识库查询性能
   - 记录知识库数据更新日志
   - 优化知识库数据结构和索引

## 未来规划

### 技术演进
- **微服务架构**: 考虑微服务拆分
- **云原生**: 容器化和云原生部署
- **AI增强**: 更多AI功能集成
- **实时通信**: WebSocket实时功能

### 功能扩展
- **移动端**: 双APK策略已实现
- **桌面端**: Electron应用
- **API开放**: 第三方集成API
- **插件系统**: 可扩展插件架构

---

**注意**: 本文档随着项目发展持续更新，记录项目经验和最佳实践。