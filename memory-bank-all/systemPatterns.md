# 系统架构与模式

## 整体架构

### 前后端分离架构
```
┌─────────────────────────────────────────────────────────────┐
│                        前端层                                │
│  Next.js 16 + React 19 + TypeScript + Tailwind CSS          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ HTTP/REST API
┌─────────────────────────────────────────────────────────────┐
│                        后端层                                │
│  FastAPI + PostgreSQL + Redis + OpenAI API                  │
└─────────────────────────────────────────────────────────────┘
```

### 数据流架构
```
用户界面 → React Context → API客户端 → FastAPI路由 → 业务逻辑 → 数据库
    ↑                                                           ↓
    └─────────────────── 响应数据 ←─────────────────────────────┘
```

## 前端架构模式

### 1. Next.js App Router模式
- **路由组织**: `app/` 目录按功能模块组织页面
- **布局系统**: `layout.tsx` 提供全局结构和共享组件
- **服务端渲染**: 支持SSR和客户端渲染混合模式
- **代码分割**: 自动按路由分割代码，优化加载性能

### 2. React组件模式
- **函数组件**: 全面使用React 19函数组件和Hooks
- **客户端渲染**: 交互组件使用 `"use client"` 指令
- **组合模式**: 通过组件组合构建复杂UI
- **属性传递**: 明确的props接口，保持组件独立性

### 3. 状态管理模式
- **Context Providers**: 
  - `AiAssistantProvider` 管理AI面板状态
  - `RecommendationsProvider` 管理推荐数据
- **本地状态**: 组件内部使用 `useState` 管理局部状态
- **状态提升**: 共享状态通过Context提升到合适层级
- **不可变更新**: 使用函数式更新保证状态一致性

### 4. UI组件体系
- **基础组件**: `components/ui` 目录封装基础UI组件
- **Radix UI集成**: 基于Radix UI构建可访问性组件
- **设计系统**: 统一的设计语言和样式规范
- **组件复用**: 高度可复用的组件设计

## 后端架构模式

### 1. 分层架构模式
```
┌─────────────────┐
│   API路由层     │ ← 处理HTTP请求，参数验证
├─────────────────┤
│   业务逻辑层     │ ← 实现核心业务逻辑
├─────────────────┤
│   数据访问层     │ ← 数据库操作和ORM映射
├─────────────────┤
│   数据存储层     │ ← PostgreSQL + Redis
└─────────────────┘
```

### 2. 依赖注入模式
- **FastAPI依赖**: 使用Depends系统管理组件依赖
- **服务注入**: 业务服务通过依赖注入获取
- **配置注入**: 数据库连接、外部API等配置注入
- **生命周期管理**: 自动管理组件创建和销毁

### 3. 仓储模式
- **基础仓储**: `app/db/base.py` 定义通用CRUD操作
- **具体仓储**: 每个模型有对应的仓储类
- **查询封装**: 复杂查询逻辑封装在仓储层
- **事务管理**: 在仓储层处理数据库事务

### 4. 服务层模式
- **业务服务**: `app/services/` 目录包含业务逻辑
- **外部服务**: OpenAI等服务封装为独立服务
- **服务编排**: 复杂业务流程通过服务编排实现
- **错误处理**: 统一的错误处理和异常管理

## 数据架构模式

### 1. 关系型数据库设计
- **实体关系**: 清晰的实体关系定义
- **规范化**: 遵循数据库规范化原则
- **索引策略**: 关键字段建立索引优化查询
- **约束完整性**: 外键约束保证数据完整性

### 2. 缓存模式
- **Redis缓存**: 热点数据缓存到Redis
- **缓存策略**: 基于TTL的缓存过期策略
- **缓存更新**: 数据变更时同步更新缓存
- **缓存穿透**: 防止缓存穿透的保护机制

### 3. 数据迁移模式
- **Alembic迁移**: 使用Alembic管理数据库版本
- **增量迁移**: 每次变更创建增量迁移脚本
- **回滚支持**: 支持迁移回滚操作
- **环境同步**: 开发、测试、生产环境数据库同步

## 安全架构模式

### 1. 认证授权模式
- **JWT认证**: 使用JWT令牌进行用户认证
- **权限控制**: 基于角色的访问控制(RBAC)
- **令牌管理**: 令牌刷新和过期管理
- **安全中间件**: CORS、安全头等中间件保护

### 2. 数据保护模式
- **密码哈希**: 使用bcrypt哈希用户密码
- **敏感数据**: 敏感信息加密存储
- **数据脱敏**: 日志中敏感数据脱敏处理
- **传输安全**: HTTPS加密数据传输

## API设计模式

### 1. RESTful API模式
- **资源导向**: 以资源为中心的API设计
- **HTTP方法**: 正确使用GET、POST、PUT、DELETE
- **状态码**: 标准HTTP状态码表示操作结果
- **版本控制**: API版本管理策略

### 2. 数据验证模式
- **Pydantic模型**: 使用Pydantic进行数据验证
- **序列化**: 统一的请求/响应序列化
- **错误处理**: 详细的错误信息和验证反馈
- **文档生成**: 自动生成API文档

## 性能优化模式

### 1. 前端优化
- **代码分割**: 按路由和组件分割代码
- **懒加载**: 非关键资源懒加载
- **缓存策略**: 浏览器缓存和CDN缓存
- **资源优化**: 图片压缩、资源合并

### 2. 后端优化
- **数据库优化**: 查询优化、连接池管理
- **缓存策略**: 多层缓存提高响应速度
- **异步处理**: 异步I/O提高并发能力
- **负载均衡**: 支持水平扩展的架构设计

## 错误处理模式

### 1. 前端错误处理
- **错误边界**: React错误边界捕获组件错误
- **全局错误**: 统一的全局错误处理机制
- **用户反馈**: 友好的错误信息展示
- **错误上报**: 错误信息收集和上报

### 2. 后端错误处理
- **异常处理**: 统一的异常处理机制
- **错误日志**: 详细的错误日志记录
- **错误响应**: 标准化的错误响应格式
- **监控告警**: 关键错误监控和告警

## 测试架构模式

### 1. 测试分层
- **单元测试**: 组件和函数级别的测试
- **集成测试**: API和数据库集成测试
- **端到端测试**: 完整用户流程测试
- **性能测试**: 负载和压力测试

### 2. 测试策略
- **测试驱动**: 关键功能采用TDD开发
- **持续集成**: CI/CD流水线自动运行测试
- **测试覆盖率**: 保持高测试覆盖率
- **测试数据**: 管理测试数据和测试环境

## 部署架构模式

### 1. 容器化部署
- **Docker容器**: 应用容器化部署
- **容器编排**: 使用Docker Compose管理服务
- **环境隔离**: 开发、测试、生产环境隔离
- **配置管理**: 外部化配置管理

### 2. 监控运维
- **日志管理**: 集中化日志收集和分析
- **性能监控**: 应用性能监控和告警
- **健康检查**: 服务健康状态检查
- **备份恢复**: 数据备份和灾难恢复